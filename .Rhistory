checkParameterOrder = TRUE))
## up to 30s
system.time(rep1 <- obj$report()) ## one off caclulation using start pars
head(rep1$catch_yf_pred,df$yRun)
head(df$catch_yf_obs,df$yRun)
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c("shireAEP1010",'shire_v2','shire_v2L')[3]
compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6, move = TRUE) ## data that works with OM
# df$v1 = 0.99; df$Fmax = 3;
df$v1 = 0.7;  df$Fmax = 1.5;
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 44
df$yRun = 2;# df$yRun = df$tEnd-1
df$mat_age = rep(0, df$nage)
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## up to 30s
system.time(rep1 <- obj$report()) ## one off caclulation using start pars
head(rep1$catch_yf_pred,df$yRun)
head(df$catch_yf_obs,df$yRun)
# likes <- rep1$ans_tot %>% matrix(., ncol = length(.)) %>% data.frame()
# names(likes) = c("SDR","CATCH","SURVEY","SURVCOMP","CATCHCOMP","PRIORS")
# likes
source(here('R','functions','boundPars.R')) ## bound selex etc
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
# for (k in 1:2)  opt <- nlminb(obj$env$last.par.best, obj$fn, obj$gr)
best <- obj$env$last.par.best ## update object with the best parameters
## 81 s
dat <- obj$report(par = best)
head(dat$catch_yf_pred,10)
head(df$catch_yf_obs,10)
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c("shireAEP1010",'shire_v2','shire_v2L')[3]
compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6, move = TRUE) ## data that works with OM
# df$v1 = 0.99; df$Fmax = 3;
df$v1 = 0.7;  df$Fmax = 1.5;
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 44
df$yRun = 2;# df$yRun = df$tEnd-1
df$mat_age = rep(0, df$nage)
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## up to 30s
system.time(rep1 <- obj$report()) ## one off caclulation using start pars
head(rep1$catch_yf_pred,df$yRun)
head(df$catch_yf_obs,df$yRun)
rep1$N_yais_beg[1:2]
rep1$N_yais_beg[1,,1]
rep1$N_yais_beg[1,,,1]
rep1$N_yais_beg[1,1:4,,1]
rep1$N_yais_beg[1:2,1:4,,1]
rep1$N_yais_mid[1:2,1:4,,1]
rep1$N_yais_end[1:2,1:4,,1]
rep1$N_yais_beg[1:2,1:4,,1]
rep1$R_0k
rep1$R_yk
rep1$SSB_0k
rep1$N_0ais
df$mat_age
df <- load_data_OM(nspace = 6, move = TRUE) ## data that works with OM
# df$v1 = 0.99; df$Fmax = 3;
df$v1 = 0.7;  df$Fmax = 1.5;
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 44
df$yRun = 2;# df$yRun = df$tEnd-1
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
system.time(rep1 <- obj$report()) ## one off caclulation using start pars
head(rep1$catch_yf_pred,df$yRun)
head(df$catch_yf_obs,df$yRun)
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 1000
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## up to 30s
system.time(rep1 <- obj$report()) ## one off caclulation using start pars
head(rep1$catch_yf_pred,df$yRun)
head(df$catch_yf_obs,df$yRun)
# likes <- rep1$ans_tot %>% matrix(., ncol = length(.)) %>% data.frame()
# names(likes) = c("SDR","CATCH","SURVEY","SURVCOMP","CATCHCOMP","PRIORS")
# likes
source(here('R','functions','boundPars.R')) ## bound selex etc
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
best <- obj$env$last.par.best ## update object with the best parameters
## 81 s
dat <- obj$report(par = best)
head(dat$catch_yf_pred,10)
head(df$catch_yf_obs,10)
df$niter = 22
df$yRun = 3;# df$yRun = df$tEnd-1
dllUSE
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
# for (k in 1:2)  opt <- nlminb(obj$env$last.par.best, obj$fn, obj$gr)
best <- obj$env$last.par.best ## update object with the best parameters
## 81 s
dat <- obj$report(par = best)
head(dat$catch_yf_pred,10)
head(df$catch_yf_obs,10)
df$yRun = 5;# df$yRun = df$tEnd-1
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
# for (k in 1:2)  opt <- nlminb(obj$env$last.par.best, obj$fn, obj$gr)
best <- obj$env$last.par.best ## update object with the best parameters
## 81 s
dat <- obj$report(par = best)
head(dat$catch_yf_pred,10)
head(df$catch_yf_obs,10)
df$yRun = 6;# df$yRun = df$tEnd-1
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
?TMBhelper::fit_tmb
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
# getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
df$yRun = 10;# df$yRun = df$tEnd-1
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
# getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
rm(list = ls())
gc()
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c("shireAEP1010",'shire_v2','shire_v2L')[3]
# compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6, move = TRUE) ## data that works with OM
# df$v1 = 0.99; df$Fmax = 3;
df$v1 = 0.7;  df$Fmax = 1.5;
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 22
df$yRun = 10;# df$yRun = df$tEnd-1
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## up to 30s
# system.time(rep1 <- obj$report()) ## one off caclulation using start pars
# head(rep1$catch_yf_pred,df$yRun)
# head(df$catch_yf_obs,df$yRun)
# likes <- rep1$ans_tot %>% matrix(., ncol = length(.)) %>% data.frame()
# names(likes) = c("SDR","CATCH","SURVEY","SURVCOMP","CATCHCOMP","PRIORS")
# likes
source(here('R','functions','boundPars.R')) ## bound selex etc
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
# for (k in 1:2)  opt <- nlminb(obj$env$last.par.best, obj$fn, obj$gr)
best <- obj$env$last.par.best ## update object with the best parameters
## 81 s
dat <- obj$report(par = best)
head(dat$catch_yf_pred,10)
head(df$catch_yf_obs,10)
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
rm(list = ls())
ry(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c("shireAEP1010",'shire_v2','shire_v2L')[2]
# compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6, move = TRUE) ## data that works with OM
# df$v1 = 0.99; df$Fmax = 3;
df$v1 = 0.7;  df$Fmax = 1.5;
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 22
df$yRun = 10;# df$yRun = df$tEnd-1
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c("shireAEP1010",'shire_v2','shire_v2L')[2]
# compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6, move = TRUE) ## data that works with OM
# df$v1 = 0.99; df$Fmax = 3;
df$v1 = 0.7;  df$Fmax = 1.5;
# df$v1 = 0.65; df$Fmax = 1.15;
df$niter = 22
df$yRun = 10;# df$yRun = df$tEnd-1
mappy <- list(
# logh_k = factor(rep(NA, 4)),
# logR_0k = factor(rep(NA, 4)), ## sum wc = 12
omega_0ij = factor(matrix(NA, nrow = 6, ncol = 6)),
# logq_f = factor(rep(NA, 5)),
b =  factor(rep(NA, 60))
# logpi_acomp = factor(rep(NA,df$nfleets_acomp)),
# logSDR = factor(NA),
## structure is fleet x alpha, beta x time block (1 for now)x sex
# log_fsh_slx_pars = factor(array(NA, dim = c(df$nfleets_fish,2,1,2)))
# log_srv_slx_pars =  factor(array(NA, dim = c( df$nfleets_surv+(df$nfleets_acomp-5),2,1,2)))
)
## ~90s with full years
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll =dllUSE,
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
## up to 30s
# system.time(rep1 <- obj$report()) ## one off caclulation using start pars
# head(rep1$catch_yf_pred,df$yRun)
# head(df$catch_yf_obs,df$yRun)
# likes <- rep1$ans_tot %>% matrix(., ncol = length(.)) %>% data.frame()
# names(likes) = c("SDR","CATCH","SURVEY","SURVCOMP","CATCHCOMP","PRIORS")
# likes
source(here('R','functions','boundPars.R')) ## bound selex etc
## about 65s for 22 years
## 7 hours for 44 yrs
## 3hrs for all years with bounds (just catch like)
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = lower,
upper = upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repreat for stability)
system.time(rep1 <- obj$report()) ## one off caclulation using start pars
head(rep1$catch_yf_pred,df$yRun)
head(df$catch_yf_obs,df$yRun)
