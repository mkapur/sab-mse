library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
# df.new$omega_ai[,] <- 1
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
reps$LengthAge_alyi_beg[,,,1]
reps$LengthAge_alyi_beg[,,,1] %>%
melt()
reps$LengthAge_alyi_beg[,,,1] %>%
melt() %>% head()
geom_tile()
reps$LengthAge_alyi_beg[,,,1] %>%
melt() %>%
ggplot(.,aes(x = Var1, y = Var2, fill = value)) +
geom_tile()
reps$LengthAge_alyi_beg[,,,1] %>%
melt() %>% hist(value)
a1 <-
reps$LengthAge_alyi_beg[,,,1] %>%
melt()
class(a1$value)
hist(a1$value)
summary(a1$value)
ggplot(a1,aes(x = Var1, y = Var2, fill = value)) +
geom_tile()
reps$Length_yai_beg
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$Length_yai_beg[1,,1]) ## init l at age
points(reps$Length_yai_mid[1,,25],pch = 19) ## init l at age
points(reps$Length_yai_mid[25,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[25,,1],pch = 19) ## init l at age
reps$Length_yai_mid[25,,1]
reps$N_yai_beg[25,,1]
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[25,,1],pch = 19) ## init l at age
points(reps$Length_yai_beg[25,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_beg[25,,1],pch = 19) ## init l at age
reps$Length_yai_beg[25,,1]
reps$Length_yai_beg[1:5,,1
]
reps$N_yai_beg[1:5,,1]
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$N_yai_beg[1,,1]) ## init l at age
points(reps$N_yai_beg[25,,1],pch = 19) ## init l at age
reps$N_yai_beg[25,,1]
points(reps$N_yai_beg[5,,1],pch = 19) ## init l at age
parms$logh_k
exp(parms$logh_k)
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_beg[25,,1],pch = 19) ## init l a
reps$Length_yai_beg[25,,1]
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_beg[2:6,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_beg[2:6,,1],pch = 19) ## init l at age
reps$Length_yai_beg[2:6,,1]
points(reps$Length_yai_beg[2:6,,1],pch = 19) ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_beg[3,,1],pch = 19) ## init l at age
points(reps$Length_yai_beg[6,,1],pch = 19) ## init l at age
dat <- data.frame("age" = 1:95, "len" = NA, "linflnow" = NA)
dat[1,"len"] <- 4.5
for(i in 2:nrow(dat)){
dat[i,"linflnow"] = 125.5 - dat[i-1,"len"]
dat[i,"len"] <- eq2(Lnow = dat[i-1,"len"],K = 0.3,Linf = 125.5)
}
# with(dat, plot(len ~ age))
plot(1:95, growth(k = 0.3, lmin = 4.5, lmax = 65, ages = 95, a3 = 3, a4 = 70), pch = 20) ## LMAX IS NO
growth <- function(k, lmin, lmax, ages, a3, a4)
{
len      <- matrix(NA, ages, 1)
a.linear <- a3 ## age at which linear growth stops
len.step <- ifelse(lmin < 4, lmin, 4)  ## lmin is size at age 0 (?)
#L infinity (cm)
Linf <- lmax + ((lmax - lmin) / (1 - exp( -k * (a4 - a3)))) ## years of VB growth
len.slope <- (lmin - len.step) / a3 ## linear growth slope
# Length at the start of the year (cm)
len[1:(a.linear+1),1]<-len.step[1]+len.slope*(seq(1, (a.linear + 1), 1) - 1)
# Growth based on the VB
len[(a.linear+2):ages,1] <- Linf + (lmin - Linf)*exp(-k*((seq(a.linear+2, ages,1)-1)-a3))
# Growth based on the VB
len[1:ages,1] <- Linf + (lmin - Linf)*exp(-k*(1:ages))
#Plus Group Growth
temp1 <- sum(exp(-0.20*(ages:(ages*2)-ages))*(len[ages,1]+((ages:(ages*2)-ages)/ages)*(Linf-len[ages,1])))
temp2 <- sum(exp(-0.20*(ages:(ages*2)-ages)))
len[ages,1] <- temp1 / temp2
return(len)
}
eq2 <- function(Lnow, K, Linf){
lthen = Lnow + (Linf - Lnow)*(1-exp(-K))
return(lthen)
}
dat <- data.frame("age" = 1:95, "len" = NA, "linflnow" = NA)
dat[1,"len"] <- 4.5
for(i in 2:nrow(dat)){
dat[i,"linflnow"] = 125.5 - dat[i-1,"len"]
dat[i,"len"] <- eq2(Lnow = dat[i-1,"len"],K = 0.3,Linf = 125.5)
}
# with(dat, plot(len ~ age))
plot(1:95, growth(k = 0.3, lmin = 4.5, lmax = 65, ages = 95, a3 = 3, a4 = 70), pch = 20) ## LMAX IS NOT LINF
with(dat, points(len ~ age,  col = "blue", pch = 20))
legend('bottomright', col = c("black","blue"), pch = 20, legend = c('Synthesis', "Shire"))
dat
## load growth params
growPar <- read.csv(here("input","raw","Table3_2020-05-06phase2.csv"))
## load growth params
growPar <- read.csv(here("input","raw","Table3_2020-05-06phase2.csv"))
growPar
growPar$L1[growPar$Period == 'early']
## parameter placeholders
Linf_yk <-L1_yk <- kappa_yk <- sigmaG_yk <- matrix(NA, nrow = length(years), ncol = nstocks)
L1_yk[1:(2009-1966),1:nstocks] <-  growPar$L1[growPar$Period == 'early'][1:nstocks]
L1_yk[(2009-1966):nrow(L1_yk),1:nstocks] <-  growPar$L1[growPar$Period == 'late'][1:nstocks]
L1_yk[(2009-1966):nrow(L1_yk),1:nstocks] <-  growPar$L1[growPar$Period == 'late'][1:nstocks]
L1_yk
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
## OM MODEL CONDITIONING ----
# code from runomem and run om condition
set.seed(731)
plot.figures = FALSE # Set true for printing to file
# Run the simulation model
assessment <- read.csv(here("input","data",'assessment_MLE.csv')) ## I believe this comes from SS3
assessment <- assessment[assessment$year > 1965 &assessment$year < 2018 ,]
Catch.obs <- read.csv(here("input","data",'hake_totcatch.csv'))
df <- load_data_seasons(nspace =2)
df$Catch <- Catch.obs$Fishery
time <- 1
yrinit <- df$nyear
### Run the OM and the EM for x number of years in the MSE
### Set targets for harvesting etc
# df$parms$initN <- df$parms$initN*0
# df$parms$Rin <- df$parms$Rin*0
# df$F0 <- 0*df$F0
simyears <- 25 # Project 30 years into the future (2048 that year)
year.future <- c(df$years,(df$years[length(df$years)]+1):(df$years[length(df$years)]+simyears))
N0 <- NA
sim.data <- run.agebased.true.catch(df)
simdata0 <- sim.data # The other one is gonna get overwritten.
# Plot stuff
parms <- getParameters_OM(trueparms = FALSE, df = df)
##  Create a data frame to send to runsabassessment
df.new <- create_TMB_data(sim.data, df, history = TRUE)
parms.new <- parms
F0 <- rowSums(sim.data$Fout)
Rdev <- parms$Rin
parms.new$F0 <- F0
parms.new$Rin <- Rdev
## testing without omega
# df.new$omega_ai[,] <- 1
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$N_yai_beg[1,,1]) ## init l at age
points(reps$N_yai_beg[5,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
reps$Length_yai_beg[1,,1]
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_MID[1,,1], color = 'blue') ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
df.new$L1_yk
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$N_yai_beg[1,,1]) ## init l at age
points(reps$N_yai_beg[5,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'blue') ## init l at age
reps$Length_yai_beg[2,,1]
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'blue') ## init l at age
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'blue') ## init l at age
reps$Length_yai_beg
reps$Length_yai_beg[2,,1]
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'blue') ## init l at age
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$Length_yai_beg[1,,1], ylim = c(0,100)) ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[25,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[25,,1], col = 'green') ## init l at age
points(reps$Length_yai_beg[53,,1],pch = 19) ## init l at age
points(reps$Length_yai_mid[53,,1], col = 'green') ## init l at age
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$Length_yai_beg[1,,1], pch = 19, ylim = c(0,100), main = 'L @ AGE, filled points are midyr, cols are yrs', col = 'blue') ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19, col = 'red') ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'red') ## init l at age
points(reps$Length_yai_beg[53,,1],pch = 19, col = 'green') ## init l at age
points(reps$Length_yai_mid[53,,1], col = 'green') ## init l at age
plot(reps$Length_yai_beg[1,,1], pch = 19, ylim = c(0,200), main = 'L @ AGE, filled points are midyr, cols are yrs', col = 'blue') ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19, col = 'red') ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'red') ## init l at age
points(reps$Length_yai_beg[53,,1],pch = 19, col = 'green') ## init l at age
points(reps$Length_yai_mid[53,,1], col = 'green') ## init l at age
reps$Length_yai_beg[1,,1]
reps$Length_yai_mid[53,,1]
reps$N_yai_beg[523,,1]
reps$N_yai_beg[53,,1]
reps$N_yai_beg[40:52,,1]
reps$N_yai_beg[20:39,,1]
reps$N_yai_beg[1:19,,1]
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$N_yai_beg[1,,1]) ## init l at age
points(reps$N_yai_beg[5,,1],pch = 19) ## init l at age
reps$N_yai_beg[1:10,,1]
plot(reps$Length_yai_beg[1,,1], pch = 19, ylim = c(0,200), main = 'L @ AGE, filled points are midyr, cols are yrs', col = 'blue') ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19, col = 'red') ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'red') ## init l at age
points(reps$Length_yai_beg[53,,1],pch = 19, col = 'green') ## init l at age
points(reps$Length_yai_mid[53,,1], col = 'green') ## init l at age
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
plot(reps$N_yai_beg[1,,1]) ## init l at age
points(reps$N_yai_beg[5,,1],pch = 19) ## init l at age
plot(reps$Length_yai_beg[1,,1], pch = 19, ylim = c(0,200), main = 'L @ AGE, filled points are midyr, cols are yrs', col = 'blue') ## init l at age
plot(reps$Length_yai_beg[1,,1], pch = 19, ylim = c(0,200), main = 'L @ AGE, filled points are midyr, cols are yrs', col = 'blue') ## init l at age
points(reps$Length_yai_mid[1,,1], col = 'blue') ## init l at age
points(reps$Length_yai_beg[2,,1],pch = 19, col = 'red') ## init l at age
points(reps$Length_yai_mid[2,,1], col = 'red') ## init l at age
points(reps$Length_yai_beg[53,,1],pch = 19, col = 'green') ## init l at age
points(reps$Length_yai_mid[53,,1], col = 'green') ## init l at age
## OM_Master.R
## M S Kapur mod from N Jacobsen Summer 2020
## kapurm@uw.edu
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
source(here("R","functions",'load_files_OM.R'))
compile(here("TMB","runsabassessment.cpp"))
dyn.load(dynlib(here("TMB","runsabassessment")))
obj <- MakeADFun(df.new,
parms.new,
DLL= "runsabassessment") # Run the assessment, in TMB folder
reps <- obj$report()
a1 <-
reps$LengthAge_alyi_beg[,,,1] %>%
melt()
ggplot(a1,aes(x = Var1, y = Var2, fill = value)) +
geom_tile()
