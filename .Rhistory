sum(dat$N_yais_beg[4,,1,1])
sum(dat$N_yais_end[4,,1,1])
sum(dat$N_yais_end[4,,1,1])+ dat$R_yi[4,1]/2
dat$surv_yf_pred/df$surv_yf_obs
## save everything and plot
cppname = substr(dllUSE,7,nchar(dllUSE))
writeOM(justPlots = FALSE,
dat=dat,
obj = obj,
opt = opt,
rep=rep,
cppname =cppname,
mappy = mappy,
runname = paste0("-",df$yRun,"y_",
cppname,
"_tildeR_yON",
"_onlyAKVASTEest",
"_B_y0_off"))
srv_blks_size <- matrix(1, nrow = 1, ncol = nfleets_surv+nfleets_acomp-4)
colnames(srv_blks_size) <- c( as.character(fltnames_surv), as.character(fltnames_acomp[c(2,4,5)]))
srv_blks_size[,'WC_VAST'] <- 3
srv_blks_size[,'AK_VAST_E'] <- 2
# srv_blks is an h x nfleets_surv imatrix with the MAX year of a given timeblock.
# it will be a ragged array bc some fleets have fewer blocks.
srv_blks <- matrix(2019, nrow = max(srv_blks_size),
ncol = nfleets_surv+nfleets_acomp-4)
colnames(srv_blks) <- c( as.character(fltnames_surv), as.character(fltnames_acomp[c(2,4,5)]))
srv_blks[1:srv_blks_size[,'AK_VAST_E'],'WC_VAST' ] <- c(1995,2003,2019)
srv_blks[1:srv_blks_size[,'AK_VAST_E'],'AK_VAST_E' ] <- c(1995,2019)
srv_blks <- srv_blks-1960 ## zero index!
source('C:/Users/mkapur/Dropbox/UW/sab-mse/R/functions/load_data_OM.R')
## OM_Master.R
## M S Kapur
## Inspiration & code guidance from J Sullivan, N Jacobsen Summer 2020
## kapurm@uw.edu
rm(list = ls())
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c('shire_v4')[1]
# compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6,
move = TRUE,
b_y_max = 0.109) ## data that works with OM
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6,
move = TRUE,
b_y_max = 0.109) ## data that works with OM
df$surv_yf_obs[df$surv_yf_obs >0] <-  df$surv_yf_obs[df$surv_yf_obs >0]*1000
df$yRun <- df$tEnd ## number of years to run model
df$parms$mort_k <- c(0.2,0.2,0.2,0.2)
df$Neqn <- buildNeqn(df)
df$srv_blks
load("C:/Users/mkapur/Dropbox/UW/sab-mse/output/2021-01-15 07_56_55-60y_v4_tildeR_yON_estWC_FIX_srvblksON/mappy.rdata")
mappy
rm(mappy)
# df$parms$b_y <- rep(0,df$tEnd) ## no ramp right now.
mappy <-
buildMap(toFix =  c("omega_0ij",
"logh_k",
"logSDR",
# "tildeR_yk",
"b_y",
"epsilon_tau",
"logpi_acomp",
"log_fsh_slx_pars",
"log_srv_slx_pars",
"mort_k"),
fixFlt = c("all_fsh",
c( paste0(c(as.character(df$fltnames_surv),as.character(df$fltnames_acomp[c(2,4,5)])))[-2] )))
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll = dllUSE,
# random = "tildeR_y",
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
bounds <- boundPars(obj,
r0_lower = 0,
boundSlx = c(NA,'fsh','srv')[2:3])
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = bounds$lower,
upper = bounds$upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repeat for stability)
best <- obj$env$last.par.best ## update object with the best parameters
dat <- obj$report(par = best)
dat$surv_yf_pred/df$surv_yf_obs
survey_yf_predt <- data.frame(dat$surv_yf_pred)
names(survey_yf_predt) <- df$fltnames_surv
survey_yf_predt <- survey_yf_predt %>%
mutate(Year = years) %>%
melt(id = 'Year') %>%
mutate(Type = 'PRED') %>%
mutate(REG = substr(variable,0,2)) %>%
filter(value > 0)
survey_yf_errt <- data.frame(df$surv_yf_err) %>%
mutate(Year = years) %>%
melt(id = 'Year') %>%
filter(!is.na(value))
spmat <- data.frame(subarea = c('A4',"A3","B3","B2","C2","C1"),
stock = c("R4","R3","R3","R2","R2","R1"),
mgmt = c("AI","AK", rep("BC",2), rep("CC",2)))
inames = rev(unique(spmat$subarea))
years <- 1960:2019
nyear <- length(years)
tEnd <- length(years)
age <- 0:70
nage <- length(age)
survey_yf_predt <- data.frame(dat$surv_yf_pred)
names(survey_yf_predt) <- df$fltnames_surv
survey_yf_predt <- survey_yf_predt %>%
mutate(Year = years) %>%
melt(id = 'Year') %>%
mutate(Type = 'PRED') %>%
mutate(REG = substr(variable,0,2)) %>%
filter(value > 0)
survey_yf_errt <- data.frame(df$surv_yf_err) %>%
mutate(Year = years) %>%
melt(id = 'Year') %>%
filter(!is.na(value))
survey_yf_obst <- data.frame( df$surv_yf_obs)  %>%
mutate(Year = years) %>%
melt(id = 'Year') %>%
filter(value > 0) %>%
merge(survey_yf_errt, by = c('Year','variable')) %>%
mutate(value = value.x) %>%
## convert CV to SD via CV = mean/sd
## we think these are sds in mt (input to model as log)
mutate(Type = 'OBS',
lci = round(value - value*(value.y)),
uci = round(value + (value*value.y))) %>%
mutate(REG = substr(variable,0,2)) %>%
select(Year, variable, value, lci, uci)
ggplot(data = survey_yf_obst,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(x = df$srv_blks[variable])
melt(df$srv_blks)
melt(df$srv_blks) %>% head()
melt(df$srv_blks) %>% filter(value != 59) %>% mutate(variable = Var2) %>%
select(variable, value)
melt(df$srv_blks) %>% filter(value != 59) %>% mutate(variable = Var2, blk = value) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable')
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(x = blk, col = 'grey88') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
?geom_vline
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(xintercept = blk, col = 'grey88') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>% head()
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(data = ., xintercept = blk, col = 'grey88') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
ggplot(data = srv_obs_blk,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(data = srv_obs_blk, xintercept = blk, col = 'grey88') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
ggplot(data = srv_obs_blk,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(aes( xintercept = blk), col = 'grey88') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(aes( xintercept = blk), col = 'grey88') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(aes( xintercept = blk), col = 'grey88', lwd = 2, linetype = 'dashed') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(aes( xintercept = blk), col = 'grey88', lwd = 1, linetype = 'dashed') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(aes( xintercept = blk), col = 'grey60', lwd = 1, linetype = 'dashed') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
geom_vline(aes( xintercept = blk), col = 'grey75', lwd = 1, linetype = 'dashed') +
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable') %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_vline(aes( xintercept = blk), col = 'grey75',
lwd = 1, linetype = 'dashed') +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
melt(df$srv_blks) %>%
filter(value != 59) %>%
mutate(variable = Var2, blk = value+1960) %>%
select(variable, blk) %>%
merge(.,
survey_yf_obst,
by = 'variable', all.y = TRUE) %>%
ggplot(data = .,
aes(x = Year, y = value, color = variable)) +
geom_vline(aes( xintercept = blk), col = 'grey75',
lwd = 1, linetype = 'dashed') +
geom_line(data = survey_yf_predt, lwd = 0.75) +
scale_color_manual(values = survfltPal) +
geom_point(pch = 1, fill = NA, col = 'black') +
geom_errorbar(aes(ymin = lci, ymax = uci), col = 'black',width=0) +
scale_x_continuous(limits = c(1980,ifelse(df$yRun == 59,2021,1959+df$yRun)),
breaks = seq(1980,1960+df$yRun,10),
labels = seq(1980,1960+df$yRun,10)) +
theme_sleek() +
theme(legend.position = 'none')+
labs(y = 'survey', color = 'Fishing Fleet')+
facet_wrap(~variable, scales = "free_y")
debugSource('C:/Users/mkapur/Dropbox/UW/sab-mse/R/functions/writeOM.R')
# dat$catch_yf_pred_total/df$catch_yf_obs[,2:ncol(df$catch_yf_obs)]
## save everything and plot
cppname = substr(dllUSE,7,nchar(dllUSE))
writeOM(justPlots = FALSE,
dat=dat,
obj = obj,
opt = opt,
rep=rep,
cppname =cppname,
mappy = mappy,
runname = paste0("-",df$yRun,"y_",
cppname,
"_tildeR_yON",
"_onlyAKVASTEest95blk",
"_B_y0_off"))
paste0(c(as.character(df$fltnames_surv),as.character(df$fltnames_acomp[c(2,4,5)])))
## OM_Master.R
## M S Kapur
## Inspiration & code guidance from J Sullivan, N Jacobsen Summer 2020
## kapurm@uw.edu
rm(list = ls())
library(TMB)
library(dplyr)
library(reshape2)
library(ggplot2)
library(r4ss)
library(here)
library(ggsidekick)
dllUSE = c('shire_v4')[1]
# compile(here("TMB",paste0(dllUSE,".cpp")))
dyn.load(dynlib(here("TMB",dllUSE)))
source(here("R","functions",'load_files_OM.R'))
df <- load_data_OM(nspace = 6,
move = TRUE,
b_y_max = 0.109) ## data that works with OM
df$surv_yf_obs[df$surv_yf_obs >0] <-  df$surv_yf_obs[df$surv_yf_obs >0]*1000
df$yRun <- df$tEnd ## number of years to run model
df$parms$mort_k <- c(0.2,0.2,0.2,0.2)
df$Neqn <- buildNeqn(df)
# df$parms$b_y <- rep(0,df$tEnd) ## no ramp right now.
mappy <-
buildMap(toFix =  c("omega_0ij",
"logh_k",
"logSDR",
# "tildeR_yk",
"b_y",
"epsilon_tau",
"logpi_acomp",
"log_fsh_slx_pars",
"log_srv_slx_pars",
"mort_k"),
fixFlt = c("all_fsh",
c( paste0(c(as.character(df$fltnames_surv),as.character(df$fltnames_acomp[c(2,4,5)])))[-1] )))
# mappy$logh_k <- factor(c(NA,NA,2,3)) ##  fix WC regs
# mappy$b_y <- factor(c(1,rep(NA,59))) ## enable estimation of year 1 b_y ## consider mirroring for these guys
# mappy$tildeR
df$srv_blks
system.time(obj <- MakeADFun(df,
parameters = df$parms,
dll = dllUSE,
# random = "tildeR_y",
map = mappy, ## fix everything for testing eigen fails
checkParameterOrder = TRUE))
bounds <- boundPars(obj,
r0_lower = 0,
boundSlx = c(NA,'fsh','srv')[2:3])
system.time(opt <-
TMBhelper::fit_tmb(
obj,
lower = bounds$lower,
upper = bounds$upper,
dll = dllUSE,
getHessian = FALSE,
control = list(eval.max = 1e6,
iter.max = 1e6,
rel.tol = 1e-4)
)$opt) ## estimate; can repeat for stability)
best <- obj$env$last.par.best ## update object with the best parameters
dat <- obj$report(par = best)
dat$surv_yf_pred/df$surv_yf_obs
# dat$catch_yf_pred_total/df$catch_yf_obs[,2:ncol(df$catch_yf_obs)]
## save everything and plot
cppname = substr(dllUSE,7,nchar(dllUSE))
writeOM(justPlots = FALSE,
dat=dat,
obj = obj,
opt = opt,
rep=rep,
cppname =cppname,
mappy = mappy,
runname = paste0("-",df$yRun,"y_",
cppname,
"_tildeR_yON",
"_onlyAKVASTWest",
"_B_y0_off"))
exp(3.688)
exp(4.24)
